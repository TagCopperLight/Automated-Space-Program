<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="css/style.css">
        <link rel="icon" href="images/favicon.ico" type="image/x-icon">

        <script src="https://unpkg.com/socket.io-client@4.5.3/dist/socket.io.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <div class="page">
        </div>
        <script>
            function addData(chart, x, y) {
                chart.data.labels.push(x);
                chart.data.datasets.forEach((dataset) => {
                    dataset.data.push(y);
                });
                chart.update('none');
            };

            function resetData(chart){
                chart.data.labels = []
                chart.data.datasets.forEach((dataset) => {
                    dataset.data = []
                });
                chart.update('none');
            }

            var socket = io();

            var charts = [];
            var inited = false;

            socket.on('message', function(message) {
                if (message.type == 'init'){
                    if (message.data.length > 0){
                        inited = true;

                        message.data[0].data_type.forEach(data_type => {
                            $('.page').append('<div class="chart"><canvas id="' + data_type + '_chart" style="width: 100%; height: 100%;"></canvas></div>');
                        });

                        //Push all data types and create charts from saved data
                        message.data[0].data_type.forEach(data_type => {
                            eval('var ' + data_type + `_chart = new Chart(document.getElementById('` + data_type + `_chart'), {
                                type: 'line',
                                data: {
                                    labels: [],
                                    datasets: [{
                                        label: data_type.charAt(0).toUpperCase() + data_type.slice(1),
                                        pointRadius: 0,
                                            borderColor: '#b4befe',
                                            borderWidth: 2,
                                            data: []
                                        }]
                                    },
                                    options: {
                                        scales: {
                                            y: {
                                                grid: {
                                                    color: "#181825"
                                                },
                                                ticks: {
                                                    color: "#cdd6f4"
                                                }
                                            },
                                            x: {
                                                grid: {
                                                    color: "#181825"
                                                },
                                                ticks: {
                                                    color : "#cdd6f4",
                                                    display: false
                                                }
                                            }
                                        },
                                        animation: false,
                                        plugins: {
                                            legend: {
                                                display: false
                                            }
                                        }
                                    }
                            });`);
                            charts.push([data_type, eval(data_type + '_chart')]);
                        });

                        //Push all saved data
                        message.data.forEach(data => {
                            charts.forEach(element => {
                                eval('addData(element[1], data.data.' + element[0] + '.time, data.data.' + element[0] + '.' + element[0] + ');');
                            });
                        });
                    };

                } else if (message.type == 'data'){
                    if (!inited){
                    }
                    
                } else if(message.type == 'reset'){
                    resetData(altitude_chart);
                    resetData(velocity_chart);
                }

                socket.emit('message', {type:'acknowledge'});
            });
        </script>
    </body>
</html>